# MVP 要件定義

## このMVPが解く問い

「ユーザーが学習を続けているか・離脱しかけているか」を判断できる最小のデータ基盤を作る。

## 設計の3原則

| # | 原則 | 説明 |
|---|------|------|
| 1 | 記録を落とさない | 行動ログは後から取り直せない。分析やUIは後から足せる。「書き込みの信頼性」に全振りする |
| 2 | テーブルは3つまで | テーブルが増えるほどJOINが増え、マイグレーションが増え、2週間に収まらなくなる |
| 3 | APIは3本まで | エンドポイントが増えるとテスト・ドキュメント・認証の工数が線形に増える。「書く」「読む（集計）」「読む（デバッグ）」の3本に絞る |

## MVPスコープ

| 項目 | 内容 |
|------|------|
| スプリント | 2週間（10営業日） |
| テーブル数 | 3（users / activities / events） |
| APIエンドポイント数 | 3 |
| イベント種別 | 6種（固定） |
| 技術スタック | FastAPI + PostgreSQL 16 |
| 認証 | Bearer Token（静的）。v2でOAuth2 |

## 機能要件

### 必須（Must）

- [ ] `POST /v1/events` — イベントのバッチ記録（最大100件、アトミック書き込み）
- [ ] `GET /v1/users/{id}/summary` — ストリーク・週間学習頻度・平均セッション時間の集計
- [ ] `GET /v1/users/{id}/events` — イベント生データの取得（デバッグ・CS対応用）
- [ ] event_type の命名規約バリデーション（正規表現 + 長さ + 禁止文字）

### 捨てたもの（v2以降で復活）

| 捨てたもの | 理由 | 復活タイミング |
|---|---|---|
| `contexts` テーブル | 教材/コースの管理はCMSの責務。MVPでは `activities.metadata` に最低限の情報を持たせる | v2：複数教材を横断分析する時点 |
| `streaks_cache` テーブル | ストリークはクエリ時に `events` から計算する。日次アクティブユーザーが1万人を超えるまでは十分高速 | v2：レスポンスが200msを超えた時点 |
| `contexts` の階層構造 | コース→章→セクションの木構造はCMS側で管理すべき | v3：学習パス推薦を実装する時点 |
| ユーザー認証 | MVPでは `external_id` で外部IdPに委任。自前認証は2週間に入らない | v2：マルチテナント対応時 |
| イベントの非同期処理 | キューイング（SQS/RabbitMQ等）はMVPでは過剰。同期書き込みで十分 | v2：秒間100イベントを超えた時点 |
| リアルタイムダッシュボード | WebSocket/SSEは工数が大きい。集計APIをポーリングで代替 | v3 |
| AI連携 | 学習分析AIは `events` テーブルを読めば動く設計にしておくが、MVP期間では接続しない | v2〜v3 |

## 非機能要件

| 項目 | 目標値 |
|------|--------|
| バッチ書き込み（100件） | 1秒以内 |
| テストカバレッジ | 80%以上 |
| エラー形式 | RFC 7807 Problem Details |
| タイムゾーン | すべてUTC（ISO 8601） |
