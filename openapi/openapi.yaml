openapi: "3.0.3"
info:
  title: Growth Loop Engine API
  version: 0.1.0
  description: |
    学習継続を支えるための行動ログ基盤（MVP）。
    教育ゲーム・企業研修・ストーリー教材に転用可能な設計。
servers:
  - url: https://api.example.com/v1
    description: Production
  - url: http://localhost:8000/v1
    description: Local development

paths:
  /events:
    post:
      operationId: createEvents
      summary: イベント記録（バッチ対応）
      description: |
        最大100件のイベントをバッチで記録する。
        全件バリデーション成功時のみ書き込み（アトミック）。
      tags: [Events]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventBatchIn'
            example:
              user_id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
              events:
                - event_type: "engagement.session_started"
                  payload:
                    client: "ios"
                    version: "1.2.0"
                  occurred_at: "2026-02-01T09:00:00Z"
                - event_type: "learning.answer_submitted"
                  payload:
                    question_id: "q-01"
                    selected: "B"
                    correct: true
                    time_ms: 4200
                  activity_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                  occurred_at: "2026-02-01T09:05:30Z"
      responses:
        "201":
          description: イベント記録成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventBatchOut'
              example:
                accepted: 2
                events:
                  - id: "550e8400-e29b-41d4-a716-446655440000"
                    received_at: "2026-02-01T09:00:01.234Z"
                  - id: "6ba7b810-9dad-11d1-80b4-00c04fd430c8"
                    received_at: "2026-02-01T09:00:01.235Z"
        "400":
          $ref: '#/components/responses/ValidationError'
        "404":
          $ref: '#/components/responses/NotFound'

  /users/{user_id}/summary:
    get:
      operationId: getUserSummary
      summary: 学習統計
      description: |
        ストリーク（連続学習日数）、週間学習頻度、
        直近30日の平均セッション時間を返す。
        キャッシュなし、リクエスト時に都度計算。
      tags: [Users]
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: 統計情報
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSummary'
              example:
                user_id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
                computed_at: "2026-02-05T12:00:00Z"
                streak:
                  current_days: 5
                  longest_days: 12
                  last_active_date: "2026-02-05"
                weekly_frequency:
                  weeks_counted: 4
                  avg_days_per_week: 4.5
                  this_week_days: 3
                session:
                  avg_duration_sec: 1080
                  total_sessions_30d: 22
        "404":
          $ref: '#/components/responses/NotFound'

  /users/{user_id}/events:
    get:
      operationId: getUserEvents
      summary: イベント履歴（デバッグ用）
      description: |
        特定ユーザーのイベント生データを時系列降順で返す。
        CS対応・デバッグ用途を想定。
      tags: [Users]
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: event_type
          in: query
          schema:
            type: string
            maxLength: 100
        - name: since
          in: query
          schema:
            type: string
            format: date-time
        - name: until
          in: query
          schema:
            type: string
            format: date-time
      responses:
        "200":
          description: イベント一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventList'
              example:
                user_id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
                total: 142
                limit: 20
                offset: 0
                events:
                  - id: "550e8400-e29b-41d4-a716-446655440000"
                    event_type: "learning.answer_submitted"
                    payload:
                      question_id: "q-01"
                      selected: "B"
                      correct: true
                      time_ms: 4200
                    activity_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                    occurred_at: "2026-02-01T09:05:30Z"
                    received_at: "2026-02-01T09:05:31.234Z"
        "404":
          $ref: '#/components/responses/NotFound'

components:
  schemas:
    EventIn:
      type: object
      required: [event_type]
      properties:
        event_type:
          type: string
          minLength: 5
          maxLength: 100
          pattern: '^[a-z][a-z0-9_]*\.[a-z][a-z0-9_]*\.[a-z][a-z0-9_]*$'
          description: "命名規約: {domain}.{object}.{action}"
        payload:
          type: object
          default: {}
          description: "最大8KB。イベント種別ごとの自由データ"
        activity_id:
          type: string
          format: uuid
          nullable: true
        occurred_at:
          type: string
          format: date-time
          nullable: true
          description: "省略時はサーバー時刻"

    EventBatchIn:
      type: object
      required: [user_id, events]
      properties:
        user_id:
          type: string
          format: uuid
        events:
          type: array
          items:
            $ref: '#/components/schemas/EventIn'
          minItems: 1
          maxItems: 100

    EventOut:
      type: object
      properties:
        id:
          type: string
          format: uuid
        received_at:
          type: string
          format: date-time

    EventBatchOut:
      type: object
      properties:
        accepted:
          type: integer
        events:
          type: array
          items:
            $ref: '#/components/schemas/EventOut'

    EventDetail:
      type: object
      properties:
        id:
          type: string
          format: uuid
        event_type:
          type: string
        payload:
          type: object
        activity_id:
          type: string
          format: uuid
          nullable: true
        occurred_at:
          type: string
          format: date-time
        received_at:
          type: string
          format: date-time

    EventList:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer
        events:
          type: array
          items:
            $ref: '#/components/schemas/EventDetail'

    StreakInfo:
      type: object
      properties:
        current_days:
          type: integer
          description: "現在の連続学習日数"
        longest_days:
          type: integer
          description: "最長の連続学習日数"
        last_active_date:
          type: string
          format: date
          description: "最終アクティブ日"

    WeeklyFrequency:
      type: object
      properties:
        weeks_counted:
          type: integer
          description: "集計対象の週数（直近4週）"
        avg_days_per_week:
          type: number
          format: float
          description: "週あたりの平均学習日数"
        this_week_days:
          type: integer
          description: "今週の学習日数"

    SessionStats:
      type: object
      properties:
        avg_duration_sec:
          type: integer
          description: "直近30日の平均セッション時間（秒）"
        total_sessions_30d:
          type: integer
          description: "直近30日のセッション数"

    UserSummary:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        computed_at:
          type: string
          format: date-time
        streak:
          $ref: '#/components/schemas/StreakInfo'
        weekly_frequency:
          $ref: '#/components/schemas/WeeklyFrequency'
        session:
          $ref: '#/components/schemas/SessionStats'

    ProblemDetail:
      type: object
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string

  responses:
    ValidationError:
      description: バリデーションエラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
          example:
            type: "https://api.example.com/errors/validation"
            title: "Validation Error"
            status: 400
            detail: "events[1].event_type: event_type must match pattern: {domain}.{object}.{action}"
            instance: "/v1/events"
    NotFound:
      description: リソースが見つからない
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
          example:
            type: "https://api.example.com/errors/not-found"
            title: "Not Found"
            status: 404
            detail: "User f47ac10b-58cc-4372-a567-0e02b2c3d479 not found"
            instance: "/v1/users/f47ac10b-58cc-4372-a567-0e02b2c3d479/summary"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer

security:
  - BearerAuth: []
